{$DOMAIN} {
    root * /usr/share/caddy
    file_server

    # Health Check
    handle_path /health {
        respond "ok"
    }

    # Pretty URL for Shadowrocket (no extension)
    @sr path /config/shadowrocket
    header @sr Content-Type "text/plain; charset=utf-8"
    header @sr Cache-Control "no-cache, must-revalidate"
    rewrite @sr /config/shadowrocket.conf

    # Pretty URL for Surge (no extension)
    @surge path /config/surge
    header @surge Content-Type "text/plain; charset=utf-8"
    header @surge Cache-Control "no-cache, must-revalidate"
    rewrite @surge /config/surge.conf

    # --- API: rule-updater (Fastify) ---
    # POST /edit/shadowrocket -> reverse proxy to rule-updater:3000
    @editShadowrocket {
        path /edit/shadowrocket
        method POST
    }
    reverse_proxy @editShadowrocket http://rule-updater:3000
    # Optional: enable simple CORS for browser clients
    header @editShadowrocket Access-Control-Allow-Origin "*"
    @preflightEditShadowrocket {
    path /edit/shadowrocket
    method OPTIONS
    }
    header @preflightEditShadowrocket Access-Control-Allow-Origin "*"
    header @preflightEditShadowrocket Access-Control-Allow-Methods "POST, OPTIONS"
    header @preflightEditShadowrocket Access-Control-Allow-Headers "*"
    respond @preflightEditShadowrocket 204

    @deleteShadowrocket {
        path /delete/shadowrocket
        method DELETE
    }
    reverse_proxy @deleteShadowrocket http://rule-updater:3000
    header @deleteShadowrocket Access-Control-Allow-Origin "*"
}