{$DOMAIN} {
    # Health Check
    handle_path /health {
        respond "ok"
    }

    # --- VSCode server (8080) ---
    @vscode {
    path /vscode
    path /vscode/*
    }
    handle @vscode {
        uri strip_prefix /vscode
        # On Linux hosts, `host.docker.internal` often does not resolve inside containers.
        # Use the host's private IP (reachable from the Caddy container) instead.
        reverse_proxy http://{$VSCODE_HOST}:8080
    }

    # Pretty URL for Shadowrocket (no extension)
    @sr path /config/shadowrocket
    header @sr Content-Type "text/plain; charset=utf-8"
    header @sr Cache-Control "no-cache, must-revalidate"
    rewrite @sr /config/shadowrocket.conf

    # Pretty URL for Surge (no extension)
    @surge path /config/surge
    header @surge Content-Type "text/plain; charset=utf-8"
    header @surge Cache-Control "no-cache, must-revalidate"
    rewrite @surge /config/surge.conf

    @gfw path /config/gfw.list
    header @gfw Content-Type "text/plain; charset=utf-8"
    header @gfw Cache-Control "no-cache, must-revalidate"
    rewrite @gfw /config/gfw.list

    @ai path /config/ai.list
    header @ai Content-Type "text/plain; charset=utf-8"
    header @ai Cache-Control "no-cache, must-revalidate"
    rewrite @ai /config/ai.list

    # --- API: rule-updater (Fastify) ---
    # POST /edit/shadowrocket -> reverse proxy to rule-updater:3000
    @editShadowrocket {
        path /edit/shadowrocket
        method POST
    }
    reverse_proxy @editShadowrocket http://rule-updater:3000
    # Optional: enable simple CORS for browser clients
    header @editShadowrocket Access-Control-Allow-Origin "*"
    @preflightEditShadowrocket {
        path /edit/shadowrocket
        method OPTIONS
    }
    header @preflightEditShadowrocket Access-Control-Allow-Origin "*"
    header @preflightEditShadowrocket Access-Control-Allow-Methods "POST, OPTIONS"
    header @preflightEditShadowrocket Access-Control-Allow-Headers "*"
    respond @preflightEditShadowrocket 204

    @deleteShadowrocket {
        path /delete/shadowrocket
        method DELETE
    }
    reverse_proxy @deleteShadowrocket http://rule-updater:3000
    header @deleteShadowrocket Access-Control-Allow-Origin "*"

    handle /gfw* {
        header Cache-Control "no-cache, must-revalidate"
        @preflight method OPTIONS
        handle @preflight {
            header Access-Control-Allow-Origin "*"
            header Access-Control-Allow-Methods "POST, DELETE, OPTIONS"
            header Access-Control-Allow-Headers "*"
            respond 204
        }
        
        @exists path /gfw/exists
        handle @exists {
            header Access-Control-Allow-Origin "*"
            reverse_proxy http://rule-updater:3000
        }

        @get method GET
        handle @get {
            header Access-Control-Allow-Origin "*"
            reverse_proxy http://rule-updater:3000
        }

        @post method POST
        handle @post {
            header Access-Control-Allow-Origin "*"
            reverse_proxy http://rule-updater:3000
        }

        @delete method DELETE
        handle @delete {
            header Access-Control-Allow-Origin "*"
            reverse_proxy http://rule-updater:3000
        } 
    }

    handle {
        root * /usr/share/caddy
        file_server
    }
}

code.{$DOMAIN} {
    # Route the VSCode web UI via subdomain
    reverse_proxy http://{$VSCODE_HOST}:8080
}